---
tags: notes, bash, tool, cli, curl
---

# ä½¿ç”¨ `curl` çš„ `--parallel` 

> :memo: `curl` æŒ‡ä»¤å°±åƒæ˜¯é›»è…¦ç³»çµ±ä¸Šçš„ç‘å£«åˆ€ï¼Œå¯é ã€å¥½ç”¨ä¸”ç„¡æ‰€ä¸åœ¨ã€‚é™¤äº† Linux å’Œ Mac ç³»çµ±å…§æœ‰æä¾›ï¼Œ[Win10 ä¹Ÿåœ¨ 2017 å¹´å¾Œå…§å»º `curl.exe`](https://curl.se/windows/microsoft.html)ã€‚æ™‚è‡³ä»Šæ—¥ï¼Œä½ å¯ä»¥èªªåœ¨ä»»ä½•å¹³å°çš„ç³»çµ±éƒ½èƒ½è¦‹åˆ°ä»–ã€‚éš¨è‘— RESTful API æ¨™æº–èˆˆèµ·ï¼Œå¾ˆæœ‰å¯èƒ½ä½ å‘¼å«ç¬¬ä¸€å€‹ APIï¼Œå°±æ˜¯é€é `curl` æŒ‡ä»¤å®Œæˆ
>
> `curl` åœ¨ [2019 çš„ 7.66 ç‰ˆ](https://daniel.haxx.se/blog/2019/07/22/curl-goez-parallel) è¿ä¾†æ–°åŠŸèƒ½ `--parallel`ï¼ŒéŠæˆ²è¦å‰‡ç”¢ç”Ÿè®ŠåŒ–ï¼Œæˆ‘å€‘ä¸éœ€å†è—‰ç”±å¤–éƒ¨å·¥å…·å¦‚ `xargs` æˆ– `GNU Parallel`ï¼Œå³å¯é”æˆä¸¦è¡ŒåŒ– (concurrency) å·¥ä½œã€‚curl é–‹ç™¼è€…æŒçºŒæ–°å¢å’Œä¿®æ­£ç›¸é—œåŠŸèƒ½ï¼Œå»ºè­°è‹¥è¦ä½¿ç”¨æ­¤åŠŸèƒ½ç›´æ¥[é¸ç”¨æœ€æ–°ç‰ˆ`curl`](https://curl.se/download.html)

::: warning
æœ¬ç¯‡æ’°æ–‡è€…ç‚ºç³»çµ±ç®¡ç†å“¡ï¼Œæ¸¬è©¦ç’°å¢ƒç‚º Bash æ­é… curl `7.84.0`  
é€é server çš„ BMC æä¾›çš„ redfish api (é¡ä¼¼ restful api)ï¼Œæ¼”ç¤º `--parallel` åŠŸèƒ½  
æœ¬æ–‡é€£çµ: https://hackmd.io/@kmo/curl_parallel  
ä»»ä½•å›é¥‹æ­¡è¿ç•™è¨€åœ¨æ­¤ç¯‡ hackmd :)  
:::

## å¯¦ä¾‹æ¼”ç¤º

::: info
:scroll: æƒ…å¢ƒèªªæ˜
- ç®¡ç†çš„ server åˆ† 3 å€‹ç¾¤çµ„ï¼Œæ¯å€‹ç¾¤çµ„æœ‰ 10 å°é›»è…¦ï¼Œå…± 30 å°é›»è…¦
- ç¾ä»£ server çš„ BMC æœå‹™ï¼Œå¹¾ä¹éƒ½æœ‰æä¾› redfish api (é¡ä¼¼ restful api)
- ä½¿ç”¨ redfish apiï¼Œå‚™ä»½ server çš„ BIOS è¨­å®šæª”

```bash=
# ç¾¤çµ„ 1 çš„é›»è…¦ IP ç¯„åœ
10.50.1.[1-10] (ä¹Ÿå°±æ˜¯ 10.50.1.1, 10.50.1.2, 10.50.1.3, ..., 10.50.1.9, 10.50.1.10)
# ç¾¤çµ„ 2 çš„é›»è…¦ IP ç¯„åœ
10.50.2.[1-10] (ä¹Ÿå°±æ˜¯ 10.50.2.1, 10.50.2.2, 10.50.2.3, ..., 10.50.2.9, 10.50.2.10)
# ç¾¤çµ„ 3 çš„é›»è…¦ IP ç¯„åœ
10.50.3.[1-10] (ä¹Ÿå°±æ˜¯ 10.50.3.1, 10.50.3.2, 10.50.3.3, ..., 10.50.3.9, 10.50.3.10)
```
- é€é api å–å¾—å–® 1 å°é›»è…¦ BIOS è¨­å®šï¼Œä¸¦å­˜æˆæª”æ¡ˆï¼Œä»¥ `10.50.1.1` ç‚ºä¾‹
```bash=
curl -sku usr:pw 'https://10.50.1.1/redfish/v1/Systems/1/bios' -o 10.50.1.1.bios.conf
```
- ps: ä¸åŒç¡¬é«”å» ç‰Œçš„ api éƒ½ç•¥æœ‰å·®ç•°ï¼Œå¯¦éš›æ‡‰ç”¨å‹™å¿…æŸ¥è©¢è‡ªå·±æ©Ÿå™¨çš„ redfish èªªæ˜æ–‡ä»¶ï¼Œæˆ–æ˜¯è©¢å•ç¡¬é«” vendor
:::
### ç›´è§€è§£æ³•
- æ­¤é¡Œç›´è§€æ–¹æ³•ï¼Œå°±æ˜¯é€é nested loop å®Œæˆ
```bash=
#!/bin/bash

for ii in {1..3}; do
  for jj in {1..30};do
  curl -sku usr:pw "https://10.50.$ii.$jj/redfish/v1/Systems/1/bios" -o "10.50.$ii.$jj.bios.conf"
  done
done
```
- ä½†æ­¤æ–¹æ³•æ•ˆç‡ä¸å¤ å¥½ï¼Œå¯¦éš›åŸ·è¡Œç´„èŠ± `47` ç§’å®Œæˆ ğŸ˜´


### åŒ¹é…å¤šå€‹ URL

- é€é curl çš„ [åŒ¹é… URL èªæ³•](https://everything.curl.dev/cmdline/globbing)(URL globbing)ï¼Œå¯ä»¥ä¸€æ¬¡åŒ¹é…å¤šå€‹ URL ä¸¦åŸ·è¡Œ ï¼Œç°¡åŒ–ä¸Šè¿°è…³æœ¬æˆç‚ºä¸€è¡ŒæŒ‡ä»¤
```bash=
curl -sku usr:pw 'https://10.50.[1-3].[1-10]/redfish/v1/Systems/1/bios'
```
- é¡Œç›®å¸Œæœ›æŠŠ bios è¨­å®šæª”å‚™ä»½ä¸‹ä¾†ï¼Œä½† URL çµå°¾åç¨±éƒ½æ˜¯ `bios`ï¼Œè‹¥ä½¿ç”¨ `-O, --remote-name` ç›´æ¥å­˜æª”ï¼Œæª”åç›¸åŒå«`bios`æœƒå½¼æ­¤è¦†è“‹ï¼Œæœ€å¾Œåªå­˜åˆ° 1 å€‹ `bios` æª”æ¡ˆ
- å› æ­¤ curl é–‹ç™¼è€…ä¹Ÿè€ƒæ…®åˆ°æ­¤æƒ…æ³ï¼Œæ‰€ä»¥ URL åŒ¹é…èªæ³•æ”¯æ´è¼¸å‡ºè®Šæ•¸ï¼Œå¯æ”¹å¯«ç‚º
```bash=
# æª”åçš„ `#1` å°æ‡‰ç¬¬ 1 å€‹åŒ¹é…èªæ³• `[1-3]`
# æª”åçš„ `#2` å°æ‡‰ç¬¬ 2 å€‹åŒ¹é…èªæ³• `[1-10]`
curl -sku usr:pw 'https://10.50.[1-3].[1-10]/redfish/v1/Systems/1/bios' -o '10.50.#1.#2.bios.conf'
```
- æ­¤æ™‚å°šæœªä¸¦è¡ŒåŒ–è™•ç†ï¼Œä½†åŸ·è¡Œæ•ˆç‡å·²ç¶“æœ‰æ”¹å–„ï¼Œå¯¦éš›åŸ·è¡Œç´„èŠ± `15` ç§’å®Œæˆ ğŸ‘Œ

### ä½¿ç”¨ `--parallel` 

::: success
- ç•¶ request çš„ URL æ˜¯ä¸åŒä¾†æºï¼Œcurl é–‹ç™¼è€…[å»ºè­°å¯ä»¥ä½¿ç”¨ `--parallel` ä¸¦è¡ŒåŒ–è™•ç†](https://everything.curl.dev/cmdline/urls/parallel)
- é™¤æ­¤ä¹‹å¤–é‚„æœ‰ 2 å€‹ option å¯æ­é…ä½¿ç”¨
  - `--parallel-immediate`: curl æœƒå„˜å¯èƒ½é‡è¤‡ä½¿ç”¨å·²å»ºç«‹çš„é€£ç·š(multiplex)ï¼Œå¯åŠ é€Ÿè™•ç†éœ€æ±‚ä¸¦æ¸›å°‘è² è¼‰ï¼Œä¸éç•¶ URL æ˜¯ä¸åŒä¾†æºï¼Œé‚£ multiplex æ•ˆæœå°±ä¸å¤§ã€‚ä½¿ç”¨æ­¤é¸é …æœƒå„˜å¯èƒ½é–‹å•Ÿæ–°é€£ç·šï¼ŒæŠŠè€ƒæ…® multiplex çš„å› å­æ¬Šé‡é™ä½ã€‚æœ¬æ–‡çš„å¯¦ä¾‹å°±å¾ˆé©åˆä½¿ç”¨
  - `--parallel-max`: é è¨­æ˜¯ 50 å€‹ä¸¦è¡Œå·¥ä½œï¼Œå¯ä»¥èª¿æ•´è‡ªå·±é©ç”¨çš„æƒ…å¢ƒ
:::

- æ¡ç”¨ `--parallel` ä¸€æ¬¡é€²è¡Œ 30 å€‹ä¸¦è¡Œé€£ç·šï¼Œæ­¤æ™‚æŒ‡ä»¤ç‚º

```bash=
curl --parallel --parallel-immediate --parallel-max 30 \
     -sku usr:pw \
     'https://10.50.[1-3].[1-10]/redfish/v1/Systems/1/bios' -o '10.50.#1.#2.bios.conf'
```
- ä¸¦è¡ŒåŒ–è™•ç†å¾Œï¼Œæ­¤æ™‚åŸ·è¡Œæ¸¬è©¦åƒ…èŠ± `0.5` ç§’å®Œæˆ ğŸ‘
### å–å¾—å›æ‡‰è³‡è¨Š
- ç•¶è™•ç†çš„ URL request æ•¸é‡å¤šï¼Œé›£å…æœƒé‡åˆ°å°æ–¹ server å¿™ç¢Œæˆ–ç•¶æ©Ÿï¼Œæ­¤æ™‚éœ€è¦å–å¾—å›æ‡‰è³‡è¨Šåˆ¤æ–·ã€‚å¯ä»¥é€é `--write-out` å–å¾— http çš„ `response_code`ï¼Œä¸¦ä¸”æ­é…å°å‡º `url` å°ç…§ã€‚æ­¤æ™‚æŒ‡ä»¤æ”¹ç‚º
```bash=
curl --write-out 'code %{response_code} url %{url}\n' \
     --parallel --parallel-immediate --parallel-max 30 \
     -sku usr:pw \
     'https://10.50.[1-3].[1-10]/redfish/v1/Systems/1/bios' -o '10.50.#1.#2.bios.conf'
```
- åŸ·è¡Œæ™‚å¯ä»¥çœ‹åˆ°å¦‚ä¸‹è³‡è¨Šå°å‡ºåœ¨è¢å¹•ã€‚ç”±æ–¼æ˜¯ä¸¦è¡Œè™•ç†ï¼Œæ‰€ä»¥ä¸¦ä¸æœƒç…§æ•¸å­—é †åºåŸ·è¡Œã€‚ä»”ç´°çœ‹æœƒæ³¨æ„æœ€å¾Œä¸€è¡Œ `10.50.3.3` çš„å›æ‡‰æ˜¯ `000`ï¼Œä»£è¡¨`10.50.3.3`æœ‰ä¸é æœŸç‹€æ³ç™¼ç”Ÿ
```bash=
code 200 url https://10.50.1.1/redfish/v1/Systems/1/bios
code 200 url https://10.50.1.4/redfish/v1/Systems/1/bios
code 200 url https://10.50.1.9/redfish/v1/Systems/1/bios

... ç•¥ ...

code 200 url https://10.50.3.10/redfish/v1/Systems/1/bios
code 200 url https://10.50.3.9/redfish/v1/Systems/1/bios
code 000 url https://10.50.3.3/redfish/v1/Systems/1/bios
```

### è®“ curl æ›´å¯é 

- å®‰å…¨æ€§: ä¸Šè¿°ä¾‹å­é€é `-u` å¾Œé¢åŠ  `usr:pw` æŒ‡å®šå¸³è™Ÿå¯†ç¢¼ï¼Œé€™ç¨®æ–¹å¼åœ¨ linux ç³»çµ±ä¸Šæ˜¯éå¸¸ä¸å®‰å…¨çš„è¡Œç‚ºï¼Œè‹¥ä½ ä½¿ç”¨çš„é›»è…¦ç‚ºå¤šäººç™»å…¥ä½¿ç”¨ï¼Œæ­¤æ™‚å…¶ä»–ç”¨æˆ¶ä¸‹ `ps -ef | grep curl` ä¹‹é¡æŒ‡ä»¤ï¼Œå³å¯çœ‹åˆ°ä½ ä½¿ç”¨ curl æŒ‡å®šçš„åƒæ•¸(ç•¶ç„¶åŒ…å«å¯†ç¢¼)ã€‚æ­¤æ™‚å‹™å¿…åƒé–± curl [`--config`](https://everything.curl.dev/cmdline/configfile) æ–¹å¼ï¼Œè‡³å°‘æŠŠå¯†ç¢¼åŒ…åœ¨ç‰¹å®šæª”æ¡ˆ
- å¯é æ€§: è‹¥è¦é€é curl æä¾›ç©©å®šçš„æœå‹™ï¼Œé‚£å‹¢å¿…å¾—è€ƒæ…®éŒ¯èª¤è™•ç†ï¼Œç•¶ timeout æˆ– fail ç­‰ä¸ç¬¦åˆé æœŸçš„å›å‚³å€¼ï¼Œè¦æ€éº¼è™•ç†ã€‚æ­¤æ™‚å¯ä»¥åƒè€ƒ [manpage](https://curl.se/docs/manpage.html) é—œæ–¼ `retry` or `fail` ç­‰é—œéµå­—çš„ optionã€‚ç•¶ç„¶æœ€å¿«æ–¹å¼åƒè€ƒ github or stackoverflow ç¶²å‹å€‘çš„è…³æœ¬ï¼Œä¸¦ä¾æ“šè‡ªå·±æƒ…å¢ƒèª¿æ•´

## å¾Œè¨˜

- curl æ˜¯ç³»çµ±ç®¡ç†è€æœ‹å‹ï¼Œè¿‘å¹´ä»¥é©šäººé€Ÿåº¦æŒçºŒæ›´æ–°ï¼Œé–‹ç™¼è€…åœ¨ 7.66 release çš„ [ blog ç•«é€™å¼µåœ–](https://daniel.haxx.se/blog/2019/09/11/curl-7-66-0-the-parallel-http-3-future-is-here/)ï¼Œä¾†è¡¨æ˜ curl æ›´æ–°æ¬¡æ•¸ä»¥æŒ‡æ•¸æˆé•·ã€‚æœŸå¾…ä¸ä¹…å°‡ä¾†ï¼Œé‚„æœ‰ä¾†è‡ªé€™ä½è€æœ‹å‹çš„æ–°æ¶ˆæ¯ ğŸ˜€
![](https://i.imgur.com/KTFofnW.png =x300)


## åƒè€ƒé€£çµ
[Everything curl](https://everything.curl.dev): curl é–‹ç™¼è€…å¯«çš„æ‰‹å†Šï¼Œè®š  
[curl çš„ manpage](https://curl.se/docs/manpage.html): ç¶²é ä¸ŠæŸ¥è©¢ option å¥½ç”¨  
[curl çš„ globbing ç¯„ä¾‹](https://unix.stackexchange.com/a/91574): stackoverflow ç¶²å‹çš„ç¯„ä¾‹  
[curl çš„ parallel ç¯„ä¾‹](https://stackoverflow.com/a/71967814): stackoverflow ç¶²å‹çš„ç¯„ä¾‹  

---
{%hackmd @kmo/widget_license %}